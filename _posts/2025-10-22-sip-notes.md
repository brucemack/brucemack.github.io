---
title: Notes on SIP
---

## SIP Handshake Notes

In this testing I used a properly configured SIP phone (.225) and an Asterisk 
server (.102). Here's the sequence, filtered for the SIP traffic.

![Capture 4](/assets/images/sip-capture-4.jpg)

## RTP Port Traversal Examination

In this testing I used a properly configured SIP phone (.225) and an Asterisk 
server (.102).

Commands used to check firewall:

        sudo firewall-cmd --get-active-zones
        sudo firewall-cmd --zone=public --list-all
        sudo firewall-cmd --zone=allstarlink --list-all

The last command shows that a custom--sip rule had been added, which likely opens
port 5060 for inbound connections from the phone.

The SIP negotiation happens on UDP port 5060 without any problems.

The final message in the SIP negotiation (OK (INVITE)) assigns UDP port 16314 
to the RTP/media. That is a random server-assigned port inside of the expected 
range of 10,000 to 20,000.

![Capture 2](/assets/images/sip-capture-2.jpg)

However, that port is **normally 
not open to inbound connections**. Notice the ICMP messages being generated 
in response to the phones RTP messages that 
tell the phone that its messages are being rejected.

![Capture 1](/assets/images/sip-capture-1.jpg)

But after a few seconds the server finally sends an RTP packet of its own 
to the phone on port 16314. This triggers the firewall hole-punch and no more 
ICMP errors are seen from the firewall.

![Capture 3](/assets/images/sip-capture-3.jpg)

